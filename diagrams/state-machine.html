<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Processing System - State Machine Diagram</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1300px;
            width: 100%;
        }
        
        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .diagram {
            position: relative;
            width: 100%;
            height: 700px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }
        
        .state {
            position: absolute;
            background: white;
            border: 3px solid;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 160px;
            text-align: center;
        }
        
        .state:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        
        .state-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .state-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 8px;
            color: #2d3748;
        }
        
        .state-desc {
            font-size: 11px;
            color: #4a5568;
            line-height: 1.4;
        }
        
        .start-state {
            border-color: #48bb78;
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
        }
        
        .pending-state {
            border-color: #ed8936;
            background: linear-gradient(135deg, #fffaf0 0%, #feebc8 100%);
        }
        
        .active-state {
            border-color: #4299e1;
            background: linear-gradient(135deg, #ebf8ff 0%, #bee3f8 100%);
        }
        
        .retry-state {
            border-color: #ecc94b;
            background: linear-gradient(135deg, #fefcbf 0%, #faf089 100%);
        }
        
        .end-state {
            border-color: #9f7aea;
            background: linear-gradient(135deg, #faf5ff 0%, #e9d8fd 100%);
        }
        
        .error-state {
            border-color: #f56565;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }
        
        .initial-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #2d3748;
            border: 3px solid #48bb78;
        }
        
        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .transition-arrow {
            stroke: #4a5568;
            stroke-width: 2.5;
            fill: none;
            marker-end: url(#arrowhead);
        }
        
        .success-arrow {
            stroke: #48bb78;
            stroke-width: 2.5;
            fill: none;
            marker-end: url(#arrowhead-success);
        }
        
        .error-arrow {
            stroke: #f56565;
            stroke-width: 2.5;
            fill: none;
            marker-end: url(#arrowhead-error);
            stroke-dasharray: 6,4;
        }
        
        .retry-arrow {
            stroke: #ed8936;
            stroke-width: 2.5;
            fill: none;
            marker-end: url(#arrowhead-retry);
            stroke-dasharray: 4,4;
        }
        
        .transition-label {
            font-size: 11px;
            fill: #2d3748;
            font-weight: 600;
            background: white;
            padding: 2px 4px;
        }
        
        .condition-label {
            font-size: 10px;
            fill: #718096;
            font-style: italic;
        }
        
        .legend {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #f7fafc;
            border-radius: 6px;
        }
        
        .legend-line {
            width: 40px;
            height: 3px;
        }
        
        .note {
            margin-top: 20px;
            padding: 15px;
            background: #edf2f7;
            border-left: 4px solid #4299e1;
            border-radius: 4px;
            font-size: 13px;
            color: #2d3748;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Job Lifecycle State Machine</h1>
        <p class="subtitle">State Transitions and Job Processing Flow</p>
        
        <div class="diagram">
            <svg>
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#4a5568" />
                    </marker>
                    <marker id="arrowhead-success" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#48bb78" />
                    </marker>
                    <marker id="arrowhead-error" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#f56565" />
                    </marker>
                    <marker id="arrowhead-retry" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#ed8936" />
                    </marker>
                </defs>
                
                <!-- Initial to Detected -->
                <path class="transition-arrow" d="M 70 100 L 140 100" />
                <text class="transition-label" x="75" y="95">new media</text>
                
                <!-- Detected to Queued -->
                <path class="transition-arrow" d="M 290 100 L 370 100" />
                <text class="transition-label" x="300" y="95">create job</text>
                
                <!-- Queued to Processing -->
                <path class="transition-arrow" d="M 450 180 L 450 260" />
                <text class="transition-label" x="455" y="225">dispatch</text>
                
                <!-- Processing to Validating -->
                <path class="transition-arrow" d="M 530 320 L 630 320" />
                <text class="transition-label" x="550" y="315">validate</text>
                
                <!-- Validating to Executing -->
                <path class="transition-arrow" d="M 780 320 L 880 320" />
                <text class="transition-label" x="800" y="315">if valid</text>
                
                <!-- Executing to Finalizing -->
                <path class="transition-arrow" d="M 960 400 L 960 490" />
                <text class="transition-label" x="965" y="450">on success</text>
                
                <!-- Finalizing to Completed -->
                <path class="success-arrow" d="M 1040 550 L 1120 550" />
                <text class="transition-label" x="1050" y="545">done</text>
                
                <!-- Error paths from Validating -->
                <path class="error-arrow" d="M 710 260 L 710 160 L 450 160 L 450 180" />
                <text class="transition-label" x="560" y="155" fill="#f56565">invalid ‚Üí requeue</text>
                
                <!-- Error paths from Executing -->
                <path class="error-arrow" d="M 880 360 L 800 410 L 710 410" />
                <text class="transition-label" x="750" y="405" fill="#f56565">on error</text>
                
                <!-- Retrying to Processing -->
                <path class="retry-arrow" d="M 600 490 L 520 440 L 520 360" />
                <text class="transition-label" x="525" y="430" fill="#ed8936">retry</text>
                
                <!-- Retrying to Failed -->
                <path class="error-arrow" d="M 600 570 L 600 630 L 780 630" />
                <text class="transition-label" x="650" y="625" fill="#f56565">max retries</text>
                <text class="condition-label" x="650" y="640">exceeded</text>
                
                <!-- Self-loop on Processing for steps -->
                <path class="transition-arrow" d="M 370 320 Q 350 280 370 240 Q 390 280 370 320" 
                      stroke-dasharray="3,3" opacity="0.5" />
                <text class="condition-label" x="310" y="275">multi-step</text>
                <text class="condition-label" x="310" y="287">processing</text>
            </svg>
            
            <!-- Initial marker -->
            <div class="initial-marker" style="top: 85px; left: 30px;"></div>
            
            <!-- Detected State -->
            <div class="state start-state" style="top: 60px; left: 140px;">
                <div class="state-icon">üëÅÔ∏è</div>
                <div class="state-name">DETECTED</div>
                <div class="state-desc">Media file found in watched location</div>
            </div>
            
            <!-- Queued State -->
            <div class="state pending-state" style="top: 60px; left: 370px;">
                <div class="state-icon">üìã</div>
                <div class="state-name">QUEUED</div>
                <div class="state-desc">Waiting in job queue for processing</div>
            </div>
            
            <!-- Processing State -->
            <div class="state active-state" style="top: 260px; left: 370px;">
                <div class="state-icon">‚öôÔ∏è</div>
                <div class="state-name">PROCESSING</div>
                <div class="state-desc">Job dequeued, workflow started</div>
            </div>
            
            <!-- Validating State -->
            <div class="state active-state" style="top: 260px; left: 630px;">
                <div class="state-icon">‚úì</div>
                <div class="state-name">VALIDATING</div>
                <div class="state-desc">Checking media integrity and format</div>
            </div>
            
            <!-- Executing State -->
            <div class="state active-state" style="top: 260px; left: 880px;">
                <div class="state-icon">üîß</div>
                <div class="state-name">EXECUTING</div>
                <div class="state-desc">Running conversion/processing tools</div>
            </div>
            
            <!-- Retrying State -->
            <div class="state retry-state" style="top: 490px; left: 520px;">
                <div class="state-icon">üîÑ</div>
                <div class="state-name">RETRYING</div>
                <div class="state-desc">Waiting before retry attempt (with backoff)</div>
            </div>
            
            <!-- Finalizing State -->
            <div class="state active-state" style="top: 490px; left: 880px;">
                <div class="state-icon">üì¶</div>
                <div class="state-name">FINALIZING</div>
                <div class="state-desc">Writing output, updating metadata</div>
            </div>
            
            <!-- Completed State -->
            <div class="state end-state" style="top: 490px; left: 1120px;">
                <div class="state-icon">‚úÖ</div>
                <div class="state-name">COMPLETED</div>
                <div class="state-desc">Job finished successfully</div>
            </div>
            
            <!-- Failed State -->
            <div class="state error-state" style="top: 600px; left: 780px;">
                <div class="state-icon">‚ùå</div>
                <div class="state-name">FAILED</div>
                <div class="state-desc">Job terminated after errors/retries</div>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-line" style="background: #4a5568;"></div>
                <span>Normal transition</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #48bb78;"></div>
                <span>Success path</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #f56565; height: 2px; border-top: 2px dashed #f56565;"></div>
                <span>Error path</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #ed8936; height: 2px; border-top: 2px dashed #ed8936;"></div>
                <span>Retry path</span>
            </div>
        </div>
        
        <div class="note">
            <strong>State Transitions:</strong> Jobs begin when media is detected, moving to QUEUED. When resources are available, jobs enter PROCESSING and proceed through VALIDATING (file checks) and EXECUTING (actual conversion). Errors trigger RETRYING with exponential backoff. After max retry attempts, jobs move to FAILED. Successful execution moves to FINALIZING (writing outputs) then COMPLETED. Each state transition is logged to the database for observability and recovery.
        </div>
    </div>
</body>
</html>